/* Postmonger 0.0.18 - https://github.com/kevinparkerson/postmonger */
(function (root, factory) {
    if (typeof define === 'function' && define.amd) {
        define([], factory);
    } else if (typeof exports === 'object') {
        module.exports = factory();
    } else {
        root.Postmonger = factory();
    }
}(this, function () {
    var Postmonger = function (options) {
        this.connections = {};
        this.sessions = {};
        this.origin = options && options.origin || '*';
        this.connect();
    };

    Postmonger.prototype.connect = function () {
        var self = this;
        if (window.addEventListener) {
            window.addEventListener('message', function (e) { self.handleMessage(e); }, false);
        } else {
            window.attachEvent('onmessage', function (e) { self.handleMessage(e); });
        }
        return this;
    };

    Postmonger.prototype.on = function (e, callback) {
        var h = this.connections[e];
        if (h) {
            h.push(callback);
        } else {
            this.connections[e] = [callback];
        }
        return this;
    };

    Postmonger.prototype.off = function (e, callback) {
        var h = this.connections[e];
        if (h) {
            if (callback) {
                var i = h.indexOf(callback);
                if (i > -1) {
                    h.splice(i, 1);
                }
            } else {
                delete this.connections[e];
            }
        }
        return this;
    };

    Postmonger.prototype.trigger = function (e, data) {
        var h = this.connections[e];
        if (h) {
            for (var i = 0; i < h.length; i++) {
                h[i].call(this, data);
            }
        }
        return this;
    };

    Postmonger.prototype.send = function (message, data) {
        var to = message.source || parent;
        to.postMessage(encode(message.method, data), message.origin || this.origin);
        return this;
    };

    Postmonger.prototype.handleMessage = function (e) {
        var self = this;
        var origin = e.origin || e.originalEvent.origin;
        var data = e.data;
        var message;
        var session;

        try {
            message = decode(data);
        } catch (err) {
            return;
        }

        if (message.id) {
            session = this.sessions[message.id];
            if (!session) {
                return;
            }
            if (session.origin === origin && message.method in this.connections) {
                this.trigger(message.method, message.data);
            }
        } else {
            this.trigger('connect', {
                origin: origin,
                source: e.source,
                data: message.data || {},
                method: message.method,
                sessionId: function () {
                    message.id = generateId();
                    self.sessions[message.id] = { origin: origin };
                    return message.id;
                }
            });
        }
    };

    Postmonger.prototype.destroy = function () {
        if (window.removeEventListener) {
            window.removeEventListener('message', this.handleMessage);
        } else {
            window.detachEvent('onmessage', this.handleMessage);
        }
        this.connections = {};
        this.sessions = {};
    };

    function encode(method, data) {
        var message = { method: method };
        if (data) {
            message.data = data;
        }
        return JSON.stringify(message);
    }

    function decode(data) {
        if (typeof data === 'string') {
            return JSON.parse(data);
        }
        return data;
    }

    function generateId() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
            var r = Math.random() * 16 | 0;
            var v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    return Postmonger;
}));
